name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  COMPOSER_CACHE_DIR: ~/.composer/cache

jobs:
  # ğŸ§ª Quality Assurance Pipeline
  quality-assurance:
    name: ğŸ” Code Quality (PHP ${{ matrix.php-version }}, Symfony ${{ matrix.symfony-version }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3']
        symfony-version: ['6.4.*', '7.0.*']
        
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo, dom, filter, gd, json, curl
        coverage: none
        tools: composer:v2
        
    - name: ğŸ“¦ Get Composer Cache Directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
    - name: ğŸ—‚ï¸ Cache Composer Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
          
    - name: âœ… Validate Composer Configuration
      run: composer validate --strict --no-check-all
      
    - name: ğŸ“‹ Install Dependencies
      run: |
        composer require symfony/framework-bundle:${{ matrix.symfony-version }} --no-update --no-scripts
        composer remove symfony/phpunit-bridge --dev --no-update || true
        composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader
        
    - name: ğŸ” Verify No PHPUnit Bridge
      run: |
        if [ -d "vendor/symfony/phpunit-bridge" ]; then
          echo "âŒ symfony/phpunit-bridge still installed - removing..."
          rm -rf vendor/symfony/phpunit-bridge
        else
          echo "âœ… symfony/phpunit-bridge successfully excluded"
        fi
        
    - name: ğŸ§¹ Code Style Check (PHP CS Fixer)
      run: vendor/bin/php-cs-fixer fix --dry-run --diff --config=.php-cs-fixer.dist.php
      
    - name: ğŸ”¬ Static Analysis (PHPStan)
      run: vendor/bin/phpstan analyse --memory-limit=1G
      
    - name: ğŸ§ª Unit Tests (PHPUnit)
      run: |
        # Ensure we're using the right PHPUnit version
        vendor/bin/phpunit --version
        vendor/bin/phpunit --colors=always --verbose

  # ğŸ”’ Security Analysis
  security-analysis:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer:v2
        
    - name: ğŸ“‹ Install Dependencies
      run: composer install --prefer-dist --no-progress --no-interaction
      
    - name: ğŸ” Symfony Security Check
      uses: symfonycorp/security-checker-action@v5
      
    - name: ğŸ›¡ï¸ Dependency Vulnerability Scan
      run: |
        composer audit --format=table || true

  # ğŸ“Š Package Validation
  package-validation:
    name: ğŸ“¦ Package Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer:v2
        
    - name: ğŸ” Composer Package Validation
      run: |
        composer validate --strict
        composer check-platform-reqs
        
    - name: ğŸ“‹ Dependency Analysis
      run: |
        composer show --tree
        composer outdated --direct || true

  # ğŸ¯ Integration Tests
  integration-tests:
    name: ğŸ”§ Integration Tests
    runs-on: ubuntu-latest
    needs: [quality-assurance]
    
    strategy:
      matrix:
        symfony-version: ['6.4.*', '7.0.*']
        
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, dom, filter, gd, json, curl
        tools: composer:v2
        
    - name: ğŸ“‹ Install Symfony ${{ matrix.symfony-version }}
      run: |
        composer require symfony/framework-bundle:${{ matrix.symfony-version }} --no-update --no-scripts
        composer install --prefer-dist --no-progress --no-interaction
        
    - name: ğŸ§ª Bundle Integration Test
      run: |
        # Test bundle can be loaded
        php -r "
        require 'vendor/autoload.php';
        use Aria1991\AIDevAssistantBundle\AIDevAssistantBundle;
        \$bundle = new AIDevAssistantBundle();
        echo 'Bundle instantiated successfully: ' . get_class(\$bundle) . PHP_EOL;
        "

  # âœ… Success Notification
  success:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs: [quality-assurance, security-analysis, package-validation, integration-tests]
    if: success()
    
    steps:
    - name: ğŸ‰ Success
      run: |
        echo "ğŸ‰ All CI/CD checks passed successfully!"
        echo "âœ… Code Quality: PASSED"
        echo "ğŸ›¡ï¸ Security: PASSED" 
        echo "ğŸ“¦ Package: VALIDATED"
        echo "ğŸ”§ Integration: PASSED"
        echo ""
        echo "ğŸš€ Ready for production deployment!"
